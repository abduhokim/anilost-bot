import logging
import random
import asyncio
from telegram import Update, ReplyKeyboardMarkup
from telegram.ext import (
    ApplicationBuilder,
    CommandHandler,
    MessageHandler,
    ContextTypes,
    filters,
)

# ğŸ§  Oddiy AI javoblar (demo uchun)
AI_RESPONSES = [
    "Qanday yordam bera olaman?",
    "Yaxshi savol. Buni oâ€˜rganamiz!",
    "Men AIman, siz bilan suhbatlashishdan xursandman!",
    "Bu haqida oâ€˜ylab koâ€˜raman :)"
]

# ğŸ Tasodifiy animelar roâ€˜yxati
ANIME_LIST = [
    {"title": "Jujutsu Kaisen", "episodes": 48, "movie": 1},
    {"title": "Attack on Titan", "episodes": 87, "movie": 0},
    {"title": "One Piece", "episodes": 1000, "movie": 15},
    {"title": "Naruto", "episodes": 720, "movie": 11},
    {"title": "Demon Slayer", "episodes": 44, "movie": 2}
]

# ğŸŒ¸ Gulli tugmalar
main_buttons = ReplyKeyboardMarkup([
    ["ğŸŒ¸ Anime menyu", "ğŸ” Kod orqali qidirish"],
    ["ğŸ¤– AI qidiruv", "ğŸ² Tasodifiy anime"],
    ["ğŸ•µ Anonim suhbat"]
], resize_keyboard=True)

# ğŸ““ Anonim chat juftlari
waiting_users = []
chat_pairs = {}

# ğŸš€ Boshlanish komandasi
async def start(update: Update, context: ContextTypes.DEFAULT_TYPE):
    await update.message.reply_text("ğŸ‘‹ Salom! Bu Anime & AI Bot!", reply_markup=main_buttons)

# ğŸ² Tasodifiy anime chiqarish
async def random_anime(update: Update, context: ContextTypes.DEFAULT_TYPE):
    anime = random.choice(ANIME_LIST)
    msg = (
        f"ğŸ <b>Anime nomi:</b> <i>{anime['title']}</i>\n"
        f"ğŸ“º <b>Qismlari:</b> <i>{anime['episodes']}</i>\n"
        f"ğŸ¬ <b>Filmlar soni:</b> <i>{anime['movie']}</i>"
    )
    await update.message.reply_text(msg, parse_mode="HTML")

# ğŸ¤– AI javobi
async def ai_response(update: Update, context: ContextTypes.DEFAULT_TYPE):
    await update.message.reply_text("ğŸ¤– " + random.choice(AI_RESPONSES))

# ğŸ“¥ Kod orqali qidirish
async def code_search(update: Update, context: ContextTypes.DEFAULT_TYPE):
    await update.message.reply_text("ğŸ” Kodni yuboring, izlab beraman!")

# ğŸ› Anime menyusi
async def anime_menu(update: Update, context: ContextTypes.DEFAULT_TYPE):
    text = "\n".join([f"{i+1}. {anime['title']}" for i, anime in enumerate(ANIME_LIST)])
    await update.message.reply_text("ğŸŒ Mashhur animelar:\n" + text)

# ğŸ•µ Anonim chat boshlash
async def anonymous_chat(update: Update, context: ContextTypes.DEFAULT_TYPE):
    user_id = update.effective_user.id
    if user_id in chat_pairs:
        await update.message.reply_text("âœ… Siz allaqachon anonim suhbatdasiz.")
        return
    if waiting_users:
        partner_id = waiting_users.pop(0)
        chat_pairs[user_id] = partner_id
        chat_pairs[partner_id] = user_id
        await context.bot.send_message(partner_id, "âœ… Sizga suhbatdosh topildi!")
        await update.message.reply_text("âœ… Sizga suhbatdosh topildi!")
    else:
        waiting_users.append(user_id)
        await update.message.reply_text("â³ Suhbatdosh qidirilmoqda...")

# ğŸ’¬ Xabar uzatish anonim chatda
async def relay_message(update: Update, context: ContextTypes.DEFAULT_TYPE):
    user_id = update.effective_user.id
    if user_id in chat_pairs:
        partner_id = chat_pairs[user_id]
        await context.bot.send_message(partner_id, update.message.text)

# ğŸ›  Asosiy funksiyalar
async def main():
    import os
    TOKEN = os.environ.get("BOT_TOKEN")
    app = ApplicationBuilder().token(TOKEN).build()

    app.add_handler(CommandHandler("start", start))
    app.add_handler(MessageHandler(filters.Regex("Anime menyu"), anime_menu))
    app.add_handler(MessageHandler(filters.Regex("Kod orqali qidirish"), code_search))
    app.add_handler(MessageHandler(filters.Regex("AI qidiruv"), ai_response))
    app.add_handler(MessageHandler(filters.Regex("Tasodifiy anime"), random_anime))
    app.add_handler(MessageHandler(filters.Regex("Anonim suhbat"), anonymous_chat))
    app.add_handler(MessageHandler(filters.TEXT & (~filters.COMMAND), relay_message))

    print("âœ… Bot ishga tushdi...")
    await app.run_polling()

if __name__ == "__main__":
    asyncio.run(main())
